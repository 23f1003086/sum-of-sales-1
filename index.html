
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Summary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
        }
        #loading {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sales Summary</h1>
        <div id="loading">Processing...</div>
        <div id="total-sales" class="alert alert-info" role="alert"></div>
        <select id="currency-picker" class="form-select mt-2">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
        </select>
        <select id="region-filter" class="form-select mt-2">
            <option value="all">All Regions</option>
            <option value="NA">North America</option>
            <option value="EU">Europe</option>
            <option value="AS">Asia</option>
        </select>
        <input type="file" id="file-input" class="form-control mt-2" accept=".csv" />
        <button id="upload-button" class="btn btn-primary mt-2">Upload CSV</button>
        <div class="mt-4">
            <table id="product-sales" class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Total Sales</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.title = 'Sales Summary';
        let exchangeRates = {};

        function processCSV(data) {
            const rows = data.split('\n');
            const salesData = {};
            let totalSales = 0;

            rows.forEach((row, index) => {
                if (index === 0) return; // Skip header
                const columns = row.split(',');
                if (columns.length > 2) {
                    const product = columns[0].trim();
                    const sales = parseFloat(columns[1]);
                    const region = columns[2].trim();
                    if (!isNaN(sales)) {
                        totalSales += sales;
                        salesData[product] = (salesData[product] || 0) + sales;
                    }
                }
            });

            return { totalSales, salesData };
        }

        function displayTotalSales(total) {
            const currency = document.querySelector('#currency-picker').value;
            const convertedTotal = (total * (exchangeRates[currency] || 1)).toFixed(2);
            document.querySelector("#total-sales").textContent = `Total Sales: ${currency} ${convertedTotal}`;
            document.querySelector("#total-sales").dataset.region = document.querySelector('#region-filter').value;
        }

        function displayProductSales(salesData) {
            const tbody = document.querySelector('#product-sales tbody');
            tbody.innerHTML = ''; // Clear existing rows
            for (const [product, sales] of Object.entries(salesData)) {
                const currency = document.querySelector('#currency-picker').value;
                const convertedSales = (sales * (exchangeRates[currency] || 1)).toFixed(2);
                const row = document.createElement('tr');
                row.innerHTML = `<td>${product}</td><td>${currency} ${convertedSales}</td>`;
                tbody.appendChild(row);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = event.target.result;
                const { totalSales, salesData } = processCSV(data);
                displayTotalSales(totalSales);
                displayProductSales(salesData);
                document.querySelector("#loading").style.display = 'none';
            };
            reader.onerror = function() {
                console.error("Error reading file");
                document.querySelector("#loading").style.display = 'none';
            };
            reader.readAsText(file);
        }

        function fetchExchangeRates() {
            fetch('rates.json')
                .then(response => response.json())
                .then(data => {
                    exchangeRates = data;
                    fetchCSVData();
                })
                .catch(error => {
                    console.error('Error fetching exchange rates:', error);
                    document.querySelector("#loading").style.display = 'none';
                });
        }

        function fetchCSVData() {
            document.querySelector("#loading").style.display = 'block';
            fetch('data.csv')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(data => {
                    handleFile(new Blob([data], { type: 'text/csv' }));
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    document.querySelector("#loading").style.display = 'none';
                });
        }

        document.getElementById('upload-button').addEventListener('click', () => {
            const fileInput = document.getElementById('file-input');
            if (fileInput.files.length > 0) {
                handleFile(fileInput.files[0]);
            } else {
                alert('Please select a file first.');
            }
        });

        document.getElementById('currency-picker').addEventListener('change', () => {
            const rows = [...document.querySelectorAll('#product-sales tbody tr')];
            const totalSales = rows.reduce((acc, row) => acc + parseFloat(row.cells[1].textContent.replace(/[^0-9.-]+/g,"")), 0);
            displayTotalSales(totalSales);
        });

        window.onload = fetchExchangeRates;
    </script>
</body>
</html>
